<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ DSL-02 Dual Agent Assembly</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>üéØ</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0b0d10; --panel: #11151aee; --border: #2a323a;
      --text: #e9e9e9; --text-muted: #9aa3ad;
      --shed: #ff5c7c; --integrate: #56ff9f; --ground: #ffb956;
      --inner: #9966ff; --outer: #56a9ff;
    }
    body {
      font-family: 'Courier New', monospace;
      background: var(--bg); color: var(--text);
      font-size: 13px; overflow: hidden; height: 100vh;
    }
    .app-shell {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    /* Corner Buttons */
    .corner-btn {
      position: fixed;
      width: 48px;
      height: 48px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: var(--text);
      z-index: 25;
      transition: all 0.2s;
    }
    .corner-btn:hover { background: var(--border); transform: scale(1.05); }
    .corner-btn.top-left { top: calc(16px + env(safe-area-inset-top)); left: calc(16px + env(safe-area-inset-left)); }
    .corner-btn.top-right { top: calc(16px + env(safe-area-inset-top)); right: calc(16px + env(safe-area-inset-right)); }
    .corner-btn.bottom-left {
      bottom: calc(16px + env(safe-area-inset-bottom));
      left: calc(16px + env(safe-area-inset-left));
    }
    
    /* Corner Menus */
    .corner-menu {
      position: fixed;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 4px;
      min-width: 200px;
      z-index: 26;
    }
    .corner-menu.visible { display: flex; }
    .corner-menu button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 12px 16px;
      text-align: left;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }
    .corner-menu button:hover { background: rgba(86,255,159,0.12); color: var(--integrate); }
    .corner-menu input {
      background: #1a1e24; border: 1px solid var(--border);
      color: var(--text); padding: 8px; border-radius: 4px;
      font-size: 11px; font-family: inherit;
    }
    
    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
      gap: 1px;
      background: var(--border);
    }
    .panel {
      flex: 1;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      min-width: 280px;
    }
    .panel-center {
      flex: 0 0 min(100vw, 400px);
    }
    
    /* Grid Panel (Center) */
    .grid-panel {
      display: flex; flex-direction: column; align-items: center;
      padding: 20px;
    }
    .grid-header {
      font-size: 11px; color: var(--text-muted); margin-bottom: 10px;
    }
    .grid {
      position: relative;
      width: 360px;
      height: 360px;
      background: #1a1e24;
      border: 1px solid var(--border);
      flex-shrink: 0; /* Prevent grid from collapsing */
    }
    .cell {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 1px solid rgba(42, 50, 58, 0.5);
      font-size: 8px;
      color: rgba(154, 163, 173, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* Cells don't intercept clicks */
    }
    .entity {
      position: absolute;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
      z-index: 10;
      pointer-events: auto; /* Entities are clickable */
    }
    .entity:hover { transform: scale(1.2); }
    .entity-label {
      font-size: 7px; color: var(--text-muted); margin-top: 2px;
    }
    
    /* Axis Readings */
    .axes {
      margin-top: 20px; width: 360px;
    }
    .axes-title {
      font-size: 11px; color: var(--text-muted); margin-bottom: 8px;
    }
    .axis-row {
      display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
      font-size: 10px;
    }
    .axis-name {
      width: 12px; font-weight: bold; color: var(--integrate);
    }
    .axis-bars {
      flex: 1; display: flex; gap: 4px; align-items: center;
    }
    .axis-bar {
      flex: 1; height: 6px; background: #1a1e24; border-radius: 3px;
      position: relative; overflow: hidden;
    }
    .axis-fill {
      height: 100%; background: var(--integrate); border-radius: 3px;
      transition: width 0.3s;
    }
    .axis-label {
      font-size: 8px; color: var(--text-muted); width: 50px;
    }
    .axis-score {
      width: 12px; text-align: center; color: var(--text);
    }
    
    /* Agent Panels */
    .agent-header {
      padding: 12px 15px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    .agent-title {
      font-size: 12px; font-weight: bold;
    }
    .agent-title.inner { color: var(--inner); }
    .agent-title.outer { color: var(--outer); }
    .turn-indicator {
      font-size: 10px; color: var(--text-muted);
    }
    
    .messages {
      flex: 1; overflow-y: auto; padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      max-height: 100%; /* Prevent overflow */
    }
    .msg {
      padding: 10px 12px; border-radius: 6px;
      font-size: 11px; line-height: 1.5;
    }
    .msg.inner {
      background: rgba(153, 102, 255, 0.15);
      border-left: 3px solid var(--inner);
    }
    .msg.outer {
      background: rgba(86, 169, 255, 0.15);
      border-left: 3px solid var(--outer);
    }
    .msg.observer {
      background: rgba(255, 185, 86, 0.15);
      border-left: 3px solid var(--ground);
    }
    .msg-operator {
      display: inline-block; padding: 2px 6px; border-radius: 3px;
      font-size: 9px; font-weight: bold; margin-right: 6px;
    }
    .msg-operator.shed { background: var(--shed); color: #000; }
    .msg-operator.integrate { background: var(--integrate); color: #000; }
    .msg-operator.ground { background: var(--ground); color: #000; }
    
    .input-bar {
      padding: 12px; border-top: 1px solid var(--border);
      display: flex; gap: 8px;
      flex-shrink: 0; /* Prevent input from being hidden */
    }
    .input-field {
      flex: 1; background: #1a1e24; border: 1px solid var(--border);
      color: var(--text); padding: 8px 10px; border-radius: 4px;
      font-size: 11px; font-family: inherit;
    }
    .send-btn {
      background: var(--integrate); color: #000; border: none;
      padding: 8px 16px; border-radius: 4px; cursor: pointer;
      font-weight: bold; font-size: 11px; font-family: inherit;
    }
    .send-btn:hover { opacity: 0.9; }
    .send-btn:disabled {
      background: #2a2e34; color: var(--text-muted); cursor: not-allowed;
    }
    
    /* Observer Panel */
    .observer-panel {
      display: flex; flex-direction: column;
      overflow: hidden; /* Prevent panel overflow */
    }
    .memo-header {
      padding: 12px 15px; border-bottom: 1px solid var(--border);
      font-size: 12px; font-weight: bold; color: var(--ground);
    }
    .memo-content {
      flex: 1; overflow-y: auto; padding: 15px;
    }
    .memo-entry {
      margin-bottom: 12px; padding: 10px; background: rgba(255,185,86,0.1);
      border-left: 3px solid var(--ground); border-radius: 4px;
      font-size: 10px; line-height: 1.5;
    }
    .memo-turn {
      font-weight: bold; color: var(--ground); margin-bottom: 4px;
    }
    .memo-agent {
      color: var(--text-muted); font-size: 9px;
    }
    
    /* Three-Options Panel */
    .options-panel {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
    }
    .option-card {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .option-card.shed { border-color: var(--shed); }
    .option-card.shed:hover { border-color: var(--shed); background: rgba(255,92,124,0.1); }
    .option-card.integrate { border-color: var(--integrate); }
    .option-card.integrate:hover { border-color: var(--integrate); background: rgba(86,255,159,0.1); }
    .option-card.ground { border-color: var(--ground); }
    .option-card.ground:hover { border-color: var(--ground); background: rgba(255,185,86,0.1); }
    .option-card.selected {
      border-width: 3px;
      box-shadow: 0 0 16px currentColor;
    }
    .option-header {
      font-size: 9px;
      font-weight: bold;
      margin-bottom: 6px;
      opacity: 0.7;
    }
    .option-card.shed .option-header { color: var(--shed); }
    .option-card.integrate .option-header { color: var(--integrate); }
    .option-card.ground .option-header { color: var(--ground); }
    .option-title {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 6px;
      line-height: 1.3;
    }
    .option-impact {
      font-size: 9px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    
    /* Observer Chat (In Center Panel) */
    .observer-chat {
      border-top: 1px solid var(--border);
      padding: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
      background: rgba(255, 185, 86, 0.05);
    }
    .observer-chat .label {
      color: var(--ground);
      font-weight: bold;
      font-size: 10px;
    }
    .observer-chat input {
      flex: 1;
      background: #1a1e24;
      border: 1px solid var(--ground);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }
    .observer-chat button {
      background: var(--ground);
      color: #000;
      border: none;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
      font-family: inherit;
    }
    .observer-chat button:hover { opacity: 0.9; }
    .observer-chat button:disabled {
      background: #2a2e34;
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    /* Bottom-left log button */
    .corner-btn.bottom-left {
      bottom: calc(16px + env(safe-area-inset-bottom));
      left: calc(16px + env(safe-area-inset-left));
    }
    
    /* Log menu */
    #logMenu {
      bottom: calc(72px + env(safe-area-inset-bottom));
      left: calc(16px + env(safe-area-inset-left));
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Corner Buttons -->
    <button class="corner-btn top-left" id="cornerKey" title="API Key">‚óé</button>
    <button class="corner-btn top-right" id="cornerHelp" title="Help">?</button>
    <button class="corner-btn bottom-left" id="cornerLog" title="Log">üìã</button>

    <!-- Corner Menus -->
    <div class="corner-menu" id="keyMenu" style="top: calc(72px + env(safe-area-inset-top)); left: calc(16px + env(safe-area-inset-left));">
      <input type="text" id="apiBase" placeholder="API Base URL" value="https://api.openai.com/v1">
      <input type="password" id="apiKey" placeholder="API Key">
      <button data-action="test-key">üîë TEST KEY</button>
    </div>

    <div class="corner-menu" id="helpMenu" style="top: calc(72px + env(safe-area-inset-top)); right: calc(16px + env(safe-area-inset-right));">
      <button data-action="start">‚ñ∂ START</button>
      <button data-action="step" disabled id="stepBtn">‚è© STEP</button>
      <button data-action="auto" disabled id="autoBtn">‚èØ AUTO</button>
      <button data-action="stop" disabled id="stopBtn">‚èπ STOP</button>
      <hr style="border: none; border-top: 1px solid var(--border); margin: 4px 0;">
      <input type="text" id="starterPrompt" placeholder="Starter: e.g., 'Build a medieval village'" style="margin-top: 4px;">
    </div>

    <div class="corner-menu" id="logMenu">
      <button data-action="export-log">üì§ EXPORT LOG</button>
      <button data-action="import-log">üì• IMPORT LOG</button>
      <button data-action="clear-log" style="color: var(--shed); margin-top: 4px;">üóë CLEAR LOG</button>
    </div>

    <!-- Main 3-Panel Layout -->
    <div class="main">
      <!-- Left: INNER Panel -->
      <div class="panel">
        <div class="agent-header">
          <div class="agent-title inner">INNER (Inside)</div>
          <div class="turn-indicator" id="innerTurn">T: -</div>
        </div>
        <div class="messages" id="innerMessages"></div>
        <div class="input-bar">
          <input type="text" class="input-field" id="innerInput" 
                 placeholder="Override INNER...">
          <button class="send-btn" id="innerSend" disabled>‚ñ∫</button>
        </div>
      </div>

      <!-- Center: Grid + Axes + Observer Memo -->
      <div class="panel panel-center observer-panel">
        <div class="grid-panel">
          <div class="grid-header">SCENE (9√ó9)</div>
          <div class="grid" id="grid"></div>
          <div class="axes">
            <div class="axes-title">AXES (T<span id="axisTime">0</span>)</div>
            <div id="axisReadings"></div>
          </div>
        </div>
        <div class="memo-header">OBSERVER OPTIONS</div>
        <div class="options-panel" id="optionsPanel">
          <div class="option-card shed">
            <div class="option-header">SHED</div>
            <div class="option-title" id="shedTitle">‚Äî</div>
            <div class="option-impact" id="shedImpact">‚Äî</div>
          </div>
          <div class="option-card integrate">
            <div class="option-header">INTEGRATE</div>
            <div class="option-title" id="integrateTitle">‚Äî</div>
            <div class="option-impact" id="integrateImpact">‚Äî</div>
          </div>
          <div class="option-card ground">
            <div class="option-header">GROUND</div>
            <div class="option-title" id="groundTitle">‚Äî</div>
            <div class="option-impact" id="groundImpact">‚Äî</div>
          </div>
        </div>
        <div class="memo-header" style="margin-top: 12px;">MEMO & REFLECTION</div>
        <div class="memo-content" id="memoContent"></div>
        <div class="observer-chat">
          <div class="label">üí¨</div>
          <input type="text" id="observerInput" placeholder="Chat with observer...">
          <button id="observerSend" disabled>Send</button>
        </div>
      </div>

      <!-- Right: OUTER Panel -->
      <div class="panel">
        <div class="agent-header">
          <div class="agent-title outer">OUTER (Outside)</div>
          <div class="turn-indicator" id="outerTurn">T: -</div>
        </div>
        <div class="messages" id="outerMessages"></div>
        <div class="input-bar">
          <input type="text" class="input-field" id="outerInput" 
                 placeholder="Override OUTER...">
          <button class="send-btn" id="outerSend" disabled>‚ñ∫</button>
        </div>
      </div>
    </div>
  </div>

  <script src="dsl-02.js"></script>
</body>
</html>
